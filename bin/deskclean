#!/usr/bin/env ruby

#
# # DeskClean
#
# Cleanup files on your desktop by moving them to directories depending on
# file extension (e.g., *.jpg goes to images/).
#
#
# ## Usage:
#
#     deskclean
#
# Force overwriting existing files:
#
#     deskclean -f
#
# Cleanup a different directory:
#
#     deskclean -p ~/Downloads
#
#
# ## Installation:
#
#     chmod +x deskclean && mv deskclean /usr/local/bin
#

require 'fileutils'
require 'optparse'

@options = { path: '~/Desktop' }

OptionParser.new do |opts|
  opts.banner = "usage: #{File.basename($0)} [options]"
  opts.on('-f', '--force', 'overwrite existing files') { @options[:force] = true }
  opts.on('-p', '--path path', 'path to desktop [default=~/Desktop]') { |path| @options[:path] = path }
end.parse!

@options.freeze

# cleanup my desktop

DESKTOP = File.expand_path(@options[:path])

# directories
file_types = {
  /.*\.(ab1|csv|sam|fasta|fastq|fa|fna|faa|gbk?|gbf|gff|aln|xlsx?)(\.gz)?$/i => 'data',
  /.*\.(csv|sam|fasta|fa|fna|faa|gbk|gbf|gff|aln|xlsx?)$/i => 'data',
  /.*\.(md|txt|docx?|rtf|html|pdf)$/i => 'textfiles',
  /.*\.(md|txt|docx?|rtf|pdf)$/i => 'textfiles',
  /.*\.(mp3)$/i => 'music'
  /.*\.(sql|pl|py|sh|rb|js|ts|coffee|c)$/i => 'scripts',
  /.*\.(svg|jpe?g|png|gif|bmp|mp4)$/i => 'images',
}

file_types.values.each do |directory_name|
  FileUtils.mkdir_p(File.join(DESKTOP, directory_name))
end

filenames = Dir.entries(DESKTOP)

filenames.each do |filename|
  destinations =
    file_types.
    each_pair.
    to_a.
    keep_if { |re, d| filename =~ re }

  if destinations.size == 1
    destination =
      File.join(File.expand_path(destinations.first.last, DESKTOP), filename)
    source =
      File.expand_path(filename, DESKTOP)

    if File.exists? destination and not @options[:force]
      puts "x #{destination} already exists"
    else
      puts "-> #{destination}"
      File.rename source, destination
    end
  elsif destinations.size > 1
    puts "?? #{source} [ambiguous]"
  end
end
